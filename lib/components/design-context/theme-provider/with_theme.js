var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.withTheme=withTheme;exports.getThemeVariables=getThemeVariables;exports.lookup=lookup;exports.default=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _lodash=_interopRequireDefault(require("lodash"));var _react=require("react");var _flat=_interopRequireDefault(require("flat"));var _antDesignPalettes=require("ant-design-palettes");var _propTypes=_interopRequireDefault(require("prop-types"));var _context=_interopRequireDefault(require("./context"));var _tinycolor=_interopRequireDefault(require("tinycolor2"));var FN_REGEX=/^(\w+)\(([^)]*)\)$/;var fns={palette:function palette(color,i){return(0,_antDesignPalettes.generate)(color)[i];},lighten:function lighten(color,amount){return new _tinycolor.default(color).lighten(amount).toString();},brighten:function brighten(color,amount){return new _tinycolor.default(color).brighten(amount).toString();},darken:function darken(color,amount){return new _tinycolor.default(color).darken(amount).toString();},desaturate:function desaturate(color,amount){return new _tinycolor.default(color).desaturate(amount).toString();},saturate:function saturate(color,amount){return new _tinycolor.default(color).saturate(amount).toString();},greyscale:function greyscale(color){return new _tinycolor.default(color).greyscale().toString();},spin:function spin(color,amount){return new _tinycolor.default(color).spin(amount).toString();},analogous:function analogous(color,num,slices,i){return new _tinycolor.default(color).analogous(num,slices)[i].toString();},complement:function complement(color){return new _tinycolor.default(color).complement().toString();},monochromatic:function monochromatic(color,num,i){return new _tinycolor.default(color).monochromatic(num)[i].toString();},splitcomplement:function splitcomplement(color,i){return new _tinycolor.default(color).splitcomplement()[i].toString();},triad:function triad(color,i){return new _tinycolor.default(color).triad()[i].toString();},tetrad:function tetrad(color,i){return new _tinycolor.default(color).tetrad()[i].toString();},mostReadable:function mostReadable(baseColor){for(var _len=arguments.length,colorList=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){colorList[_key-1]=arguments[_key];}return _tinycolor.default.mostReadable(baseColor,colorList).toString();}};function withTheme(callback,_ref){var themes=_ref.themes,themeName=_ref.themeName,variables=_ref.variables;var theme=themes[themeName];function expand(value,path,extraArgs){var valueTokens=value.toString().split(".");var pathTokens=path.toString().split(".");var newPath;if(valueTokens.length>1){pathTokens.splice.apply(pathTokens,[pathTokens.length-valueTokens.length+1,valueTokens.length-1].concat((0,_toConsumableArray2.default)(valueTokens.slice(1))));newPath=pathTokens.join(".");if(_lodash.default.has(theme,newPath)){return innerLookup(newPath,newPath,extraArgs);}}var i=pathTokens.length;while(i>=0){i-=1;newPath=[].concat((0,_toConsumableArray2.default)(pathTokens.slice(0,i-1)),["default"],(0,_toConsumableArray2.default)(pathTokens.slice(i))).join(".");if(newPath!==path&&_lodash.default.has(theme,newPath)){return innerLookup(newPath,newPath,extraArgs);}}return null;}function lookupFn(value,origPath,extraArgs){var data=value.match(FN_REGEX);var _data$slice=data.slice(1),_data$slice2=(0,_slicedToArray2.default)(_data$slice,2),fn=_data$slice2[0],args=_data$slice2[1];args=args.split(/,\s*/g).map(function(arg){if(/^_/.test(arg)){arg=expand(arg,origPath,extraArgs);}try{return JSON.parse(arg);}catch(e){return innerLookup(arg,origPath,extraArgs);}});return fns[fn].apply(fns,(0,_toConsumableArray2.default)(args));}function innerLookup(path,origPath,extraArgs){var value=_lodash.default.get(theme,path)||(/\w+(?:\.\w+)+/.test(path)?"_":path);console.log(variables,path,value);if(typeof value==="function"){value=value.apply(void 0,(0,_toConsumableArray2.default)(extraArgs));}if(/^_/.test(value)){value=expand(value,origPath,extraArgs);}else if(/^hs/.test(value)&&variables[value]){value=variables[value];}else if(FN_REGEX.test(value)){value=lookupFn(value,origPath,extraArgs);}return value;}function outerLookup(path){for(var _len2=arguments.length,extraArgs=new Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){extraArgs[_key2-1]=arguments[_key2];}var value=innerLookup(path,path,extraArgs);if(typeof keys==="function"&&keys.toString().indexOf("Command Line API")!==-1){if((0,_tinycolor.default)(value)._ok){console.log("%s = %s %c  ",path,value,"background: "+(0,_tinycolor.default)(value).toHexString()+"; font-size: x-large;");}else{console.log("%s = %s",path,value);}}return value;}function colorDifference(_a,_b){var a=(0,_tinycolor.default)(_a).toRgb();var b=(0,_tinycolor.default)(_b).toRgb();return(Math.abs(a.r-b.r)+Math.abs(a.g-b.g)+Math.abs(a.b-b.b)+100*Math.abs(a.a-b.a))/(255*3+100);}if(window.STORYBOOK_ENV){window.lookup=outerLookup;window.__deriveColorTransformation__=function(original,target){console.log("********");console.log("Original = %c  ","background: "+outerLookup(original)+"; font-size: x-large;");console.log("Target = %c  ","background: "+target+"; font-size: x-large;");console.log("********");var closest=original;var lastDifference=colorDifference(original,target);function test(path){var value=outerLookup(path);var difference=colorDifference(value,target);if(difference<lastDifference){closest=path;lastDifference=difference;if(difference===1){console.log("********");console.log("EXACT MATCH! WE HAVE A WINNER!");console.log(path);return true;}}return false;}var origString=_lodash.default.has(theme,original)?original:"\""+original+"\"";for(var i=0;i<=9;i+=1){if(test("palette("+origString+", "+i+")"))return;}for(var _i=1;_i<=100;_i+=1){if(test("lighten("+origString+", "+_i+")"))return;}for(var _i2=1;_i2<=100;_i2+=1){if(test("darken("+origString+", "+_i2+")"))return;}for(var _i3=1;_i3<=100;_i3+=1){if(test("brighten("+origString+", "+_i3+")"))return;}for(var _i4=1;_i4<=100;_i4+=1){if(test("saturate("+origString+", "+_i4+")"))return;}for(var _i5=1;_i5<=99;_i5+=1){if(test("desaturate("+origString+", "+_i5+")"))return;}if(test("greyscale("+origString+")"))return;for(var _i6=1;_i6<=5;_i6+=1){if(test("analogous("+origString+", 6, 30, "+_i6+")"))return;}for(var _i7=0;_i7<=5;_i7+=1){if(test("monochromatic("+origString+", 6, "+_i7+")"))return;}for(var _i8=1;_i8<=360;_i8+=1){if(test("spin("+origString+", "+_i8+")"))return;}if(test("complement("+origString+")"))return;for(var _i9=1;_i9<=2;_i9+=1){if(test("triad("+origString+", "+_i9+")"))return;}for(var _i10=1;_i10<=3;_i10+=1){if(test("tetrad("+origString+", "+_i10+")"))return;}for(var _i11=1;_i11<=2;_i11+=1){if(test("splitcomplement("+origString+", "+_i11+")"))return;}console.log("********");var closestValue=outerLookup(closest);console.log("NO EXACT MATCH. THE CLOSEST IS OFF BY %s%: %s",(lastDifference*100).toFixed(2),closest);console.log("COMPARE target (%s) %c  %c to match (%s) %c  ",target,"background-color: "+target+";","background-color: transparent;",closestValue,"background-color: "+(0,_tinycolor.default)(closestValue).toHexString()+";");};}return callback({lkp:{fn:outerLookup},lookup:outerLookup,theme:theme,variables:variables});}var WithTheme=function(_Component){(0,_inherits2.default)(WithTheme,_Component);function WithTheme(){(0,_classCallCheck2.default)(this,WithTheme);return(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(WithTheme).apply(this,arguments));}(0,_createClass2.default)(WithTheme,[{key:"render",value:function render(){var _this$props=this.props,fn=_this$props.children,themes=_this$props.themes,themeName=_this$props.themeName;var _this$context=this.context,ctxThemeName=_this$context.theme,variables=_this$context.variables;return withTheme(fn,{themes:themes,themeName:themeName||ctxThemeName,variables:variables});}}]);return WithTheme;}(_react.Component);exports.default=WithTheme;WithTheme.contextType=_context.default;WithTheme.propTypes={children:_propTypes.default.func,themes:_propTypes.default.object,themeName:_propTypes.default.string};function getThemeVariables(themes){var themeName=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"light";return _lodash.default.uniq(_lodash.default.values((0,_flat.default)(themes[themeName])).filter(function(v){return /^hs/.test(v);}));}function lookup(cb){return function(_ref2){var fn=_ref2.lkp.fn,props=(0,_objectWithoutProperties2.default)(_ref2,["lkp"]);return fn(typeof cb==="function"?cb(props):cb[0].replace(/\$\((\w+)\)/g,function(__,k){return props[k];}));};}